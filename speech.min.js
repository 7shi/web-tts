var langs={ja:{name:"日本語",voice:lang_ja,pitch:1},en:{name:"英語",voice:lang_en,pitch:1},fr:{name:"フランス語",voice:lang_fr,pitch:1}};function initVoices(){if(!window.speechSynthesis)return;let voices=[];function setVoices(){voices.length||(voices=speechSynthesis.getVoices(),voices.length&&Array.from(document.getElementsByClassName("voicelist")).forEach(addVoices))}function addVoices(elem){let lang=elem.getAttribute("language"),nat=null,sel=null;for(let v of voices.filter(v=>v.lang.startsWith(lang))){let opt=document.createElement("option");opt.text=v.name,opt.voice=v,elem.appendChild(opt),v.localService||(sel=opt,v.name.includes("(Natural)")&&(nat=opt))}null!=nat&&(sel=nat),null!=sel&&(sel.selected=!0)}speechSynthesis.addEventListener("voiceschanged",setVoices),setVoices()}function getTarget(elem){if(elem.getAttribute("speak"))return[elem];for(let e=elem.nextSibling;e;e=e.nextSibling)if(e.nodeName==elem.nodeName)return[e];return Array.from(elem.parentNode.parentNode.getElementsByTagName("td")).filter(e=>e!=elem&&e.classList.contains("speak"))}initVoices(),document.addEventListener("DOMContentLoaded",()=>{for(let s of Array.from(document.getElementsByClassName("speak"))){let t=s.textContent;s.speakTarget=getTarget(s);let lang=s.getAttribute("language");lang&&(s.language=langs[lang],t||(t=s.language.name)),s.textContent=t,s.addEventListener("click",()=>speak(s))}});var stopSpeaking=()=>!1;async function speak(elem){if(!window.speechSynthesis)return!0;let f=elem.classList.contains("speaking");if(stopSpeaking()&&f)return!0;elem.classList.add("speaking"),elem.playStop&&(elem.textContent=elem.playStop[1]);let cancel=1==elem.speakTarget.length?await speakLine(elem):await speakMany(elem.speakTarget);return elem.playStop&&(elem.textContent=elem.playStop[0]),elem.classList.remove("speaking"),cancel}async function speakLine(elem){let opt=elem.language.voice.selectedOptions;if(!opt||0==opt.length)return!1;let target=elem.speakTarget[0];target!=elem&&target.classList.add("speaking2");let cancel=target.words?await speakWords(elem.language,target.getElementsByTagName("span")):await speak1(elem.language,target);return target!=elem&&target.classList.remove("speaking2"),cancel}async function speakWords(lang,targets){for(let t of Array.from(targets)){t.classList.add("speaking3");let cancel=await speak1(lang,t);if(t.classList.remove("speaking3"),cancel)return!0}return!1}async function speakMany(targets){for(let t of targets){let cancel;if(await speak(t))return!0}return!1}function speak1(lang,target){return new Promise((resolve,_)=>{let speakend=cancel=>(speakend=()=>!1,cancel&&speechSynthesis.cancel(),resolve(cancel),cancel);stopSpeaking=()=>speakend(!0);let text=target.getAttribute("speak");text||(text=target.getAttribute("s")),text||(text=target.textContent);let u=new SpeechSynthesisUtterance(text);u.voice=lang.voice.selectedOptions[0].voice,u.lang=u.voice.lang,u.rate=parseFloat(lang_rate.value),u.pitch=lang.pitch,u.onend=u.onerror=()=>speakend(!1),speechSynthesis.speak(u)})}function setPlay(src,insert){let tables=src.getElementsByTagName("table");if(tables.length){for(let table of Array.from(tables))setPlay(table,insert);return}let src1=src.getElementsByTagName("tr"),lang;for(let i=0;i<src1.length;i++){let td=src1[i].getElementsByTagName("td")[0];insert&&i>=insert&&(td=src1[i].insertBefore(document.createElement("td"),td));let speak=td.classList.contains("speak"),l=td.getAttribute("language"),blank=!td.textContent.trim();speak&&(lang=l,blank&&(td.textContent=langs[l].name,blank=!1)),(speak&&td.colSpan>1||!td.childElementCount&&blank)&&(td.classList.add("speak"),td.playStop=["▶","■"],blank?td.style.width="1em":td.playStop=td.playStop.map(t=>t+" "+td.textContent.trim()),td.textContent=td.playStop[0],lang&&!td.getAttribute("language")&&td.setAttribute("language",lang))}}function makeTable(src,dst,skip){let src1=src.getElementsByClassName("sentences"),dst1=dst.getElementsByClassName("sentences"),src2=[],langs=[];for(let i=0;i<src1.length;i++){let td=src1[i].getElementsByTagName("td"),speaks=Array.from(td).filter(td=>td.classList.contains("speak"));langs.push(speaks.shift().getAttribute("language")),src2.push(speaks.map(td=>td.nextSibling))}if(skip)for(let i=0;i<skip;i++)src2.shift(),langs.shift();for(let i=0;i<dst1.length;i++){let tbody=dst1[i].getElementsByTagName("tr")[0].parentNode;for(let j=0;j<src2.length;j++){let tr=document.createElement("tr"),td=document.createElement("td");td.classList.add("speak"),td.setAttribute("language",langs[j]),tr.appendChild(td);let tdsrc=src2[j][i];tdsrc.textContent=tdsrc.textContent,tr.appendChild(tdsrc.cloneNode(!0)),tbody.appendChild(tr)}}}
//# sourceMappingURL=speech.min.js.map